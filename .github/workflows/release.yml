name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  LIB_ABI_VERSION: "1"

jobs:
  # ============ LINUX ============
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core
        working-directory: chameleon-core
        run: |
          cargo build --release
          mkdir -p ../chameleon/lib
          cp target/release/libchameleon.so ../chameleon/lib/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Go CLI
        working-directory: chameleon
        env:
          CGO_ENABLED: "1"
          CGO_LDFLAGS: "-L${{ github.workspace }}/chameleon/lib -lchameleon"
          CGO_CFLAGS: "-I${{ github.workspace }}/chameleon-core/include"
          LD_LIBRARY_PATH: "${{ github.workspace }}/chameleon/lib"
        run: |
          go build -o chameleon ./cmd/chameleon

      - name: Package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          cp chameleon/chameleon dist/
          cp chameleon/lib/libchameleon.so "dist/libchameleon.so.${VERSION}"
          ln -sf "libchameleon.so.${VERSION}" "dist/libchameleon.so.${{ env.LIB_ABI_VERSION }}"
          ln -sf "libchameleon.so.${{ env.LIB_ABI_VERSION }}" dist/libchameleon.so
          cp chameleon-core/include/chameleon.h dist/
          {
            echo "prefix=/usr/local"
            echo 'exec_prefix=${prefix}'
            echo "libdir=/usr/local/lib"
            echo "includedir=/usr/local/include"
            echo
            echo "Name: chameleon"
            echo "Description: ChameleonDB core native library"
            echo "Version: ${VERSION}"
            echo "Libs: -L/usr/local/lib -lchameleon"
            echo "Cflags: -I/usr/local/include"
          } > dist/chameleon.pc
          cd dist
          tar -czf chameleon-linux-amd64.tar.gz chameleon libchameleon.so* chameleon.h chameleon.pc
          sha256sum chameleon-linux-amd64.tar.gz > chameleon-linux-amd64.sha256

      - name: Validate package contents
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ABI="${{ env.LIB_ABI_VERSION }}"
          ARCHIVE="dist/chameleon-linux-amd64.tar.gz"
          CONTENTS="$(tar -tzf "$ARCHIVE")"
          echo "$CONTENTS"

          echo "$CONTENTS" | grep -qx "chameleon"
          echo "$CONTENTS" | grep -qx "chameleon.h"
          echo "$CONTENTS" | grep -qx "chameleon.pc"
          echo "$CONTENTS" | grep -qx "libchameleon.so"
          echo "$CONTENTS" | grep -qx "libchameleon.so.${ABI}"
          echo "$CONTENTS" | grep -qx "libchameleon.so.${VERSION}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chameleon-linux-amd64
          path: dist/chameleon-linux-amd64.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/chameleon-linux-amd64.tar.gz

  # ============ macOS ============
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core
        working-directory: chameleon-core
        run: |
          cargo build --release
          mkdir -p ../chameleon/lib
          cp target/release/libchameleon.dylib ../chameleon/lib/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Go CLI
        working-directory: chameleon
        env:
          CGO_ENABLED: "1"
          CGO_LDFLAGS: "-L${{ github.workspace }}/chameleon/lib -lchameleon"
          CGO_CFLAGS: "-I${{ github.workspace }}/chameleon-core/include"
          LD_LIBRARY_PATH: "${{ github.workspace }}/chameleon/lib"
        run: |
          go build -o chameleon ./cmd/chameleon

      - name: Package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist
          cp chameleon/chameleon dist/
          cp chameleon/lib/libchameleon.dylib "dist/libchameleon.${VERSION}.dylib"
          ln -sf "libchameleon.${VERSION}.dylib" "dist/libchameleon.${{ env.LIB_ABI_VERSION }}.dylib"
          ln -sf "libchameleon.${{ env.LIB_ABI_VERSION }}.dylib" dist/libchameleon.dylib
          cp chameleon-core/include/chameleon.h dist/
          {
            echo "prefix=/usr/local"
            echo 'exec_prefix=${prefix}'
            echo "libdir=/usr/local/lib"
            echo "includedir=/usr/local/include"
            echo
            echo "Name: chameleon"
            echo "Description: ChameleonDB core native library"
            echo "Version: ${VERSION}"
            echo "Libs: -L/usr/local/lib -lchameleon"
            echo "Cflags: -I/usr/local/include"
          } > dist/chameleon.pc
          cd dist
          tar -czf chameleon-macos-universal.tar.gz chameleon libchameleon*.dylib chameleon.h chameleon.pc
          shasum -a 256 chameleon-macos-universal.tar.gz > chameleon-macos-universal.sha256

      - name: Validate package contents
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ABI="${{ env.LIB_ABI_VERSION }}"
          ARCHIVE="dist/chameleon-macos-universal.tar.gz"
          CONTENTS="$(tar -tzf "$ARCHIVE")"
          echo "$CONTENTS"

          echo "$CONTENTS" | grep -qx "chameleon"
          echo "$CONTENTS" | grep -qx "chameleon.h"
          echo "$CONTENTS" | grep -qx "chameleon.pc"
          echo "$CONTENTS" | grep -qx "libchameleon.dylib"
          echo "$CONTENTS" | grep -qx "libchameleon.${ABI}.dylib"
          echo "$CONTENTS" | grep -qx "libchameleon.${VERSION}.dylib"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chameleon-macos-universal
          path: dist/chameleon-macos-universal.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/chameleon-macos-universal.tar.gz

  # ============ WINDOWS ============
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust core
        working-directory: chameleon-core
        run: |
          cargo build --release
          mkdir -p ../chameleon/lib
          copy target\release\chameleon.dll ..\chameleon\lib\

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Go CLI
        working-directory: chameleon
        env:
          CGO_ENABLED: "1"
          CGO_LDFLAGS: "-L${{ github.workspace }}\\chameleon\\lib -lchameleon"
          CGO_CFLAGS: "-I${{ github.workspace }}\\chameleon-core\\include"
        run: |
          go build -o chameleon.exe ./cmd/chameleon

      - name: Package
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          $VERSION = "${env:GITHUB_REF_NAME}".TrimStart('v')
          copy chameleon\chameleon.exe dist\
          copy chameleon\lib\chameleon.dll dist\
          copy chameleon-core\include\chameleon.h dist\
          @"
          prefix=/usr/local
          exec_prefix=\${prefix}
          libdir=/usr/local/lib
          includedir=/usr/local/include

          Name: chameleon
          Description: ChameleonDB core native library
          Version: $VERSION
          Libs: -L/usr/local/lib -lchameleon
          Cflags: -I/usr/local/include
          "@ | Set-Content -Path dist\chameleon.pc -NoNewline
          cd dist
          tar -czf chameleon-windows-amd64.tar.gz chameleon.exe chameleon.dll chameleon.h chameleon.pc
          certutil -hashfile chameleon-windows-amd64.tar.gz SHA256 > chameleon-windows-amd64.sha256

      - name: Validate package contents
        shell: pwsh
        run: |
          $archive = "dist/chameleon-windows-amd64.tar.gz"
          $contents = tar -tzf $archive
          $contents

          if (-not ($contents -contains "chameleon.exe")) { throw "missing chameleon.exe" }
          if (-not ($contents -contains "chameleon.dll")) { throw "missing chameleon.dll" }
          if (-not ($contents -contains "chameleon.h")) { throw "missing chameleon.h" }
          if (-not ($contents -contains "chameleon.pc")) { throw "missing chameleon.pc" }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: chameleon-windows-amd64
          path: dist/chameleon-windows-amd64.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/chameleon-windows-amd64.tar.gz
