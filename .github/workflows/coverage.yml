name: Coverage

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage-rust:
    name: Rust Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Generate Rust coverage (lcov)
        working-directory: chameleon-core
        run: cargo llvm-cov --workspace --lcov --output-path coverage-rust.lcov

      - name: Upload Rust coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: chameleon-core/coverage-rust.lcov
          flags: rust
          name: rust-coverage

  coverage-go-unit:
    name: Go Unit Tests Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust shared library for Go tests
        working-directory: chameleon-core
        run: |
          cargo build
          mkdir -p ../chameleon/lib
          cp target/debug/libchameleon.so ../chameleon/lib/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Generate Go unit tests coverage (excluding integration)
        working-directory: chameleon
        env:
          CGO_ENABLED: "1"
          CGO_LDFLAGS: "-L${{ github.workspace }}/chameleon/lib -lchameleon"
          CGO_CFLAGS: "-I${{ github.workspace }}/chameleon-core/include"
          LD_LIBRARY_PATH: "${{ github.workspace }}/chameleon/lib"
        run: |
          # Generate coverage for each package separately to avoid covdata issues
          PACKAGES=$(go list ./... | grep -v '/tests/integration')
          echo "mode: atomic" > coverage-go-unit.out
          for pkg in $PACKAGES; do
            go test -covermode=atomic -coverprofile=profile.out "$pkg" || true
            if [ -f profile.out ]; then
              tail -n +2 profile.out >> coverage-go-unit.out
              rm profile.out
            fi
          done

      - name: Upload Go unit coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: chameleon/coverage-go-unit.out
          flags: go,unit
          name: go-unit-coverage

  coverage-go-integration:
    name: Go Integration Tests Coverage
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: chameleon_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust shared library for Go tests
        working-directory: chameleon-core
        run: |
          cargo build
          mkdir -p ../chameleon/lib
          cp target/debug/libchameleon.so ../chameleon/lib/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Generate Go integration tests coverage
        working-directory: chameleon
        env:
          CGO_ENABLED: "1"
          CGO_LDFLAGS: "-L${{ github.workspace }}/chameleon/lib -lchameleon"
          CGO_CFLAGS: "-I${{ github.workspace }}/chameleon-core/include"
          LD_LIBRARY_PATH: "${{ github.workspace }}/chameleon/lib"
          CHAMELEON_TEST_DB_HOST: localhost
          CHAMELEON_TEST_DB_PORT: 5432
          CHAMELEON_TEST_DB_NAME: chameleon_test
          CHAMELEON_TEST_DB_USER: postgres
          CHAMELEON_TEST_DB_PASS: postgres
        run: |
          go test ./tests/integration/... \
            -v \
            -covermode=atomic \
            -coverprofile=coverage-go-integration.out

      - name: Upload Go integration coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: chameleon/coverage-go-integration.out
          flags: go,integration
          name: go-integration-coverage
